<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        :root { 
            --sora-iro: #87ceeb; --sakura-iro: #ffdae0; --sakura-dark: #ffb7c5;
            --bg-main: #f5f5f7; --card-bg: #ffffff; --text-main: #5d5d5d;
            --input-bg: #ffffff; --border-color: #ddd;
        }
        /* ダークモード用の変数定義 */
        [data-theme="dark"] {
            --bg-main: #1a1a1a; --card-bg: #2d2d2d; --text-main: #e0e0e0;
            --input-bg: #3d3d3d; --border-color: #444;
        }

        html, body { height: 100%; overflow: hidden; background: var(--bg-main); transition: background 0.3s; }
        body { 
            font-family: -apple-system, "Helvetica Neue", "Hiragino Kaku Gothic ProN", sans-serif; 
            color: var(--text-main); padding: 0; margin: 0; display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top);
        }

        .fixed-header-card { 
            flex: 0 0 auto; padding: 10px 12px; background: var(--card-bg); 
            border-bottom: 2px solid var(--sora-iro); z-index: 1000;
            transition: background 0.3s;
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        h3 { color: var(--sora-iro); margin: 0; font-size: 1.0em; font-weight: 800; }
        
        /* UTC時計をタップ可能に */
        .utc-clock { 
            font-family: monospace; color: var(--sora-iro); font-size: 1.6em; font-weight: bold; 
            cursor: pointer; padding: 2px 5px; border-radius: 5px; user-select: none;
        }
        .utc-clock:active { opacity: 0.6; background: rgba(135, 206, 235, 0.1); }

        .copy-area { background: var(--bg-main); border: 2px dashed var(--sakura-dark); padding: 8px; border-radius: 12px; margin-bottom: 8px; position: relative; min-height: 44px; transition: background 0.3s; }
        #outputText { white-space: pre; font-family: ui-monospace, 'Courier New', monospace; font-size: 0.85em; color: var(--text-main); line-height: 1.4; }
        .btn-copy { background: var(--sakura-iro); color: #d06070; font-size: 0.75em; padding: 6px 12px; position: absolute; top: 5px; right: 5px; border-radius: 15px; border: none; font-weight: bold; }
        
        .add-member-form { display: flex; gap: 6px; }
        input[type="text"], input[type="number"], textarea { 
            background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main); 
            padding: 10px; border-radius: 10px; font-size: 16px; outline: none; 
            box-sizing: border-box; -webkit-appearance: none; transition: background 0.3s, border 0.3s;
        }
        input#newName { flex: 2; border: 1px solid var(--sora-iro); }
        input[type="number"] { width: 65px; text-align: center; border: 1px solid var(--sora-iro); }
        .btn-add { flex: 1; background: var(--sora-iro); color: #fff; font-weight: bold; border-radius: 10px; border: none; box-shadow: 0 3px 0 #72bad9; }

        .scrollable-card { flex: 1 1 auto; overflow-y: auto; padding: 10px 12px 140px 12px; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        tr { background: var(--card-bg); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.05)); transition: background 0.3s; }
        td { padding: 12px 6px; text-align: center; font-size: 0.9em; }
        td:first-child { border-radius: 12px 0 0 12px; text-align: left; padding-left: 15px; }
        td:last-child { border-radius: 0 12px 12px 0; }
        
        .sec-input { width: 50px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--sora-iro); text-align: center; padding: 6px 0; border-radius: 8px; font-size: 1em; font-weight: bold; transition: background 0.3s; }
        .base-label { background: var(--sakura-iro); color: #d06070; font-weight: bold; font-size: 0.75em; padding: 3px 6px; border-radius: 6px; }

        .memo-section { margin-top: 15px; }
        .memo-area { 
            width: 100%; min-height: 120px; max-height: 250px;
            font-size: 15px; line-height: 1.5; resize: none; 
            border: 1px solid var(--sakura-dark); background: var(--card-bg);
            overflow-y: auto; display: block;
        }

        .footer-action { position: fixed; bottom: calc(15px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 90%; z-index: 1001; }
        .btn-reset { background: #bbb; color: #fff; width: 100%; padding: 12px; font-size: 0.85em; font-weight: bold; border-radius: 25px; border: none; opacity: 0.7; }
    </style>
</head>
<body data-theme="light">

<div class="fixed-header-card">
    <div class="top-bar">
        <h3>るびぃの起点集結</h3>
        <div class="utc-clock" id="utcClock" onclick="toggleTheme()">UTC 00:00:00</div>
    </div>
    <div class="copy-area">
        <button class="btn-copy" onclick="copyText()">コピー</button>
        <div id="outputText">入力してね</div>
    </div>
    <form class="add-member-form" onsubmit="addMember(); return false;">
        <input type="text" id="newName" placeholder="名前" lang="ja" enterkeyhint="next">
        <input type="number" id="newSec" placeholder="秒" inputmode="numeric">
        <button type="button" class="btn-add" onclick="addMember()">追加</button>
    </form>
</div>

<div class="scrollable-card" id="mainScroll">
    <table><tbody id="memberList"></tbody></table>
    <div class="memo-section">
        <textarea id="memoArea" class="memo-area" placeholder="手元のメモ（自分用）" oninput="saveMemo()"></textarea>
    </div>
</div>

<div class="footer-action"><button class="btn-reset" onclick="resetAll()">すべてリセット</button></div>

<script>
    let members = JSON.parse(localStorage.getItem('rubi_rally_v2')) || [];
    
    // ダークモード切り替え
    function toggleTheme() {
        const body = document.body;
        const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('rubi_theme', newTheme);
    }

    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            document.body.style.height = window.visualViewport.height + 'px';
            window.scrollTo(0, 0);
        });
        window.visualViewport.addEventListener('scroll', () => { window.scrollTo(0, 0); });
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('utcClock').innerText = `UTC ${String(now.getUTCHours()).padStart(2,'0')}:${String(now.getUTCMinutes()).padStart(2,'0')}:${String(now.getUTCSeconds()).padStart(2,'0')}`;
    }
    setInterval(updateClock, 1000);

    function save() { localStorage.setItem('rubi_rally_v2', JSON.stringify(members)); }
    function saveMemo() { localStorage.setItem('rubi_memo', document.getElementById('memoArea').value); }

    function addMember() {
        const n = document.getElementById('newName'), s = document.getElementById('newSec');
        if (n.value && s.value) {
            members.push({ id: Date.now(), name: n.value, seconds: parseInt(s.value) });
            n.value = ''; s.value = ''; save(); calculate(); n.focus();
        }
    }

    function removeMember(id) { members = members.filter(m => m.id !== id); save(); calculate(); }
    function updateSeconds(id, val) {
        const i = members.findIndex(m => m.id === id);
        if (i !== -1) { members[i].seconds = parseInt(val) || 0; save(); calculate(); }
    }

    function getZenkakuWidth(s) {
        let w = 0;
        for (let i = 0; i < s.length; i++) {
            const c = s.charCodeAt(i);
            w += (c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c <= 0xff9f) ? 0.5 : 1;
        }
        return w;
    }

    function calculate() {
        const tbody = document.getElementById('memberList'), out = document.getElementById('outputText');
        tbody.innerHTML = '';
        if (members.length === 0) { out.innerText = '入力してね'; return; }
        members.sort((a, b) => b.seconds - a.seconds);
        const base = members[0].seconds;
        let lines = [];
        members.forEach((m, idx) => {
            const wait = base - m.seconds;
            const isBase = idx === 0;
            let nameWithSan = m.name + "さん";
            let padding = "　".repeat(Math.max(1, Math.ceil(6.5 - getZenkakuWidth(nameWithSan))));
            let status = isBase ? "起点" : wait + "秒後";
            lines.push(`${nameWithSan}${padding}${status}`);
            tbody.innerHTML += `<tr>
                <td><strong>${m.name}</strong></td>
                <td><input type="number" class="sec-input" value="${m.seconds}" onchange="updateSeconds(${m.id}, this.value)" inputmode="numeric"></td>
                <td>${isBase ? '<span class="base-label">起点</span>' : `<span style="color:var(--sora-iro); font-weight:bold;">${wait}秒後</span>`}</td>
                <td><button type="button" style="border:none; background:none; color:#ccc; font-size:1.3em;" onclick="removeMember(${m.id})">×</button></td>
            </tr>`;
        });
        out.innerText = lines.join('\n');
    }

    function resetAll() {
        if (confirm("すべてリセットしますか？")) {
            members = []; document.getElementById('memoArea').value = '';
            save(); saveMemo(); calculate();
        }
    }

    function copyText() {
        const t = document.getElementById('outputText').innerText;
        if (!t || t.includes('入力してね')) return;
        navigator.clipboard.writeText(t).then(() => {
            const b = document.querySelector('.btn-copy');
            const old = b.innerText; b.innerText = "完了！";
            setTimeout(() => b.innerText = old, 2000);
        });
    }

    window.onload = () => {
        // 保存されたテーマを適用
        const savedTheme = localStorage.getItem('rubi_theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('memoArea').value = localStorage.getItem('rubi_memo') || '';
        updateClock(); calculate();
    };
</script>
</body>
</html>
